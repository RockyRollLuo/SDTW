/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/7.0.65
 * Generated at: 2017-04-25 00:41:59 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp.logon;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;
import java.util.Date;
import com.xietong.software.base.Power;
import com.xietong.software.util.AESUtils;
import java.util.ArrayList;
import java.util.List;
import com.xietong.software.util.Tool;
import com.xietong.software.sdtw.db.BaseUserCode;
import com.xietong.software.util.ParamUtils;
import com.xietong.software.common.*;
import org.apache.commons.logging.*;

public final class enter_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent {

public static String getIpAddress(HttpServletRequest request) {
		String ip = request.getHeader("x-forwarded-for");
		if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
			ip = request.getHeader("Proxy-Client-IP");
		}
		if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
			ip = request.getHeader("WL-Proxy-Client-IP");
		}
		if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
			ip = request.getHeader("HTTP_CLIENT_IP");
		}
		if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
			ip = request.getHeader("HTTP_X_FORWARDED_FOR");
		}
		if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
			ip = request.getRemoteAddr();
		}
		return ip;
	}
  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  private volatile javax.el.ExpressionFactory _el_expressionfactory;
  private volatile org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public javax.el.ExpressionFactory _jsp_getExpressionFactory() {
    if (_el_expressionfactory == null) {
      synchronized (this) {
        if (_el_expressionfactory == null) {
          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
        }
      }
    }
    return _el_expressionfactory;
  }

  public org.apache.tomcat.InstanceManager _jsp_getInstanceManager() {
    if (_jsp_instancemanager == null) {
      synchronized (this) {
        if (_jsp_instancemanager == null) {
          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
        }
      }
    }
    return _jsp_instancemanager;
  }

  public void _jspInit() {
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
        throws java.io.IOException, javax.servlet.ServletException {

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html; charset=utf-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("<link rel=\"stylesheet\" type=\"text/css\" href=\"../js/errormsg.css\" />\r\n");

	/*用户帐号可能不唯一，故进行判断*/
	//设置页面不缓存
	response.setHeader("Pragma", "No-cache");
	response.setHeader("Cache-Control", "no-cache");
	response.setDateHeader("Expires", 0);
	Log log = LogFactory.getLog(BaseUserCode.class);
	String scsrf = (String) session.getAttribute("csrftoken");
	String tcsrf = ParamUtils.getParameter(request, "csrftoken", "");
	if (scsrf == null || !scsrf.equals(tcsrf)) {
		response.sendRedirect(HeadConst.apache_url+"/404.jsp");
		return;
	}
	String userName = ParamUtils
			.getParameter(request, "Username", "-1").trim();
	if (userName.equals("-1")) {
		userName = ParamUtils.getParameter(request, "username", "-1")
				.trim();
	}
	String passWord = ParamUtils.getParameter(request, "pd", "-1");
	if (passWord.equals("-1")) {
		passWord = ParamUtils.getParameter(request, "code", "-1");
	}
	//String checkcode=ParamUtils.getParameter(request,"checkcode","-1");
	String skinId = ParamUtils.getParameter(request, "skinId", "blue");
	//if(!checkcode.equalsIgnoreCase(session.getAttribute("checkcode")+"")){
	//	 out.print(HtmlTool.msgBox(request, "请输入正 的验证码!", "logon.jsp", ""));
	//	 session.removeAttribute("checkcode");
	//	 return;
	//}
	//String flag=ParamUtils.getParameter(request,"flag","");
	//	int type=ParamUtils.getIntParameter(request,"type",1);
	int num = Tool.StrToInt((String) session.getAttribute("logonnum"));
	if (num > 5) {//超过五次无效登录
		Cookie[] cookies = request.getCookies();
		boolean cookieflag = false;
		for (int i = 0; i < cookies.length; i++) {
			Cookie cookie = cookies[i];
			if (cookie.getName().equals("MAINLOGONLIMIT")) {
				cookieflag = true;
				long start = Long.valueOf(cookie.getValue());
				long now = System.currentTimeMillis();
				if ((now - start) < 1000 * 60 * 10) {
					out.println(HtmlTool.msgBox(request, "登录错误次数过多，请"
							+ (10 - (now - start) / (1000 * 60))
							+ "分钟之后再登录", "../index.jsp", ""));
					return;
				} else {
					num = 0;
					Cookie tmp = new Cookie("MAINLOGONLIMIT", null);
					tmp.setMaxAge(0);
					response.addCookie(tmp);
					session.setAttribute("logonnum", "0");
				}
			}
		}
		if (!cookieflag) {
			Cookie cookie = new Cookie("MAINLOGONLIMIT",
					System.currentTimeMillis() + "");
			cookie.setMaxAge(1000 * 60 * 60);
			response.addCookie(cookie);
			out.println(HtmlTool.msgBox(request,
					"登录错误次数过多，请10分钟之后再登录！", "../index.jsp", ""));
			return;
		}
	}
	List cdt = new ArrayList();
	cdt.add("(name='" + userName + "' or code='" + userName
			+ "' or mobilephone='" + userName + "' )");
	cdt.add("enable=1");
	//登录的时候排除关联用户,避免重复
	//cdt.add("rid<=0");
	BaseUserCode[] uc = (new BaseUserCode()).queryByCondition(cdt);
	log.debug("uc.length=" + uc.length);
	if (uc.length < 1) {
		out.print(HtmlTool.msgBox(request, "请输入正确的用户帐号、代码或手机号码!",
				"../index.jsp", ""));
		return;
	} else if (uc.length > 1) {
		out.print(HtmlTool.msgBox(request,
				"您的账号不唯一。请通知您公司管理员，可先用员工编号登录！", "../index.jsp", ""));
		return;
	}
	int index = -1;
	//System.out.println(uc[0].getPwd()+"  "+Tool.encrypt(passWord)+"  "+uc[0].getId() + "  "+uc.length);
	for (int i = 0; i < uc.length; i++) {
		if (uc[i].getPwd().equals(Tool.encrypt(passWord))) {
			//	System.out.println(passWord);
			index = i;
			break;
		}
	}
	if (index == -1) {
		out.print(HtmlTool.msgBox(request, "请输入正确的密码!", "../index.jsp",
				""));
		num++;
		session.setAttribute("logonnum", num + "");
		return;
	}
	int re = ParamUtils.getIntParameter(request, "reuser", -1);
	if (re == 1) {
		Cookie cookie_un = new Cookie("SDFZUSERNAME_RE", userName);
		Cookie cookie_pwd = new Cookie("SDFZEGOVPASWARDS",
				AESUtils.encrypt("SDFZ_ZHXYabcde12", passWord));

		cookie_un.setMaxAge(365 * 24 * 60 * 60);
		cookie_pwd.setMaxAge(365 * 24 * 60 * 60);
		response.addCookie(cookie_un);
		response.addCookie(cookie_pwd);
	} else {
		Cookie cookie = new Cookie("SDFZUSERNAME_RE", "");
		Cookie cookie_pwd = new Cookie("SDFZEGOVPASWARDS", "");
		cookie.setMaxAge(0);
		cookie_pwd.setMaxAge(0);
		response.addCookie(cookie);
		response.addCookie(cookie_pwd);
	}
	/*
	String rems="";
	if(request.getParameterValues("IsRemember") !=null){
		String[] str=request.getParameterValues("IsRemember");
			
			for(int i=0;i<str.length;i++){
				rems+=","+str[i];
			}
			rems+=",";
			//majors=majors.substring(1,majors.length());
	}	
	request.setAttribute("rember",rems);

	log.debug("pwwwd:"+rems);
	
	if(",1,".equals(rems)){
		Cookie cookie_pwd = new Cookie("EGOVPASWARDS",Tool.encrypt(passWord));
		cookie_pwd.setMaxAge(1*12*60*60);
		response.addCookie(cookie_pwd);
	}else{
		Cookie cookie=new Cookie("EGOVPASWARDS",null);
		cookie.setValue(null);
		cookie.setMaxAge(0);
		cookie.setPath("/");
		response.addCookie(cookie);
	}
	 */
	//response.addCookie(cookie_pwd);
	//设置登录时选择皮肤
	if (!uc[index].getSkinId().equals(skinId)) {
		uc[index].setSkinId(skinId);
		//uc[index].update();
	}
	UserInfo ui1 = Tool.getUserInfo(request);
	if (ui1 != null) {
		ui1.removeCookie(response);
	}
	session.removeAttribute("UserInfo");
	UserInfo ui = new UserInfo(uc[index]);
	if (HeadConst.UserInfoInSession) {
		ui.setSkinId(skinId);
		session.setAttribute("userType", "jzg");
		session.setAttribute("UserInfo", ui);
	}
	ui.addCookie(response);
	BaseUserCode user = ui.getUserCode();
	String ip = getIpAddress(request);
	int type = ui.getUserCode().getDeptId();
	int LogonNum = user.getLogonNum()==-1?0:user.getLogonNum();
	if (ui.hasFunPower(Power.USERSTUDENTPOWER)) {//学生用户
		user.setLastTime(new Date());
		user.setIp(ip);
		user.setLogonNum(LogonNum+1);
		user.update();
		response.sendRedirect("../index.jsp");
	} else {//教师用户
		user.setLastTime(new Date());
		user.setIp(ip);
		user.setLogonNum(LogonNum+1);
		user.update();
		response.sendRedirect("../main/default.jsp?code=_");
	}

      out.write('\r');
      out.write('\n');
      out.write("\r\n");
      out.write("\r\n");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try {
            if (response.isCommitted()) {
              out.flush();
            } else {
              out.clearBuffer();
            }
          } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}
